---
title: "Operating Models Summary Report"
author: "Adrian Hordyk <adrian@bluematterscience.com>"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
    toc_float: yes
    number_sections: yes
subtitle: 'North Atlantic Swordfish MSE '
always_allow_html: true
params:
  OM.n: 1
---

```{css, echo=FALSE}
body .main-container {
  max-width: 1280px !important;
  width: 1280px !important;
  }
body {
  max-width: 1280px !important;
}

```


```{r setup, include=FALSE}
library(dplyr)
library(htmltools)
library(ggplot2)
knitr::opts_chunk$set(echo = FALSE)

fig.num <- tab.num <- 0
fig.cap <- function() {
  fig.num <<- fig.num +1
  paste0('Figure ',  fig.num, '.')

} 
tab.cap <- function() {
  tab.num <<- tab.num +1
  paste0('Table ',  tab.num, '.')
}

```

# Operating Model Scenarios


## Base Case Model
`r tab.cap()` Key parameter values for the base case analysis. The column names are: Natural mortality (M) - fixed parameter; standard error of recruitment deviations (sigmaR) - fixed parameter; Steepness (h) - estimated in the base case model; Coefficient of variation for the indices (CPUE CV) - varied between indices and years (range of values shown here); Effective sample size of length composition (Len. Comp. Eff. Samp. Size) - fixed; Q Increase assumed for indices (Q increase); Environmental covariate included for some indices (Env. Covariate).

```{r, results="asis"}

df <- SWOMSE::basecase_DF[,1:7] %>% dplyr::arrange(se_log)
vals <- df$se_log %>% round(2)
df$se_log <- paste(vals, sep='', collapse=" - ")
rownames(df) <- NULL
colnames(df) <- c("M", 'sigmaR', 'h', 'CPUE CV', 'Len. Comp. Eff. Samp. Size', 'Q increase', 'Env. Covariate')
df <- df[1,]
df$`Q increase` <- FALSE

suppressWarnings(
df %>% knitr::kable(escape=FALSE) %>%
  kableExtra::kable_styling() 
)

```

## Uncertainty Grid
`r tab.cap()`  The uncertainty grid is a full factorial design with the following 7 factors, resulting in `r nrow(SWOMSE::OMs_DF) ` OMs. M and h were fixed in the uncertainty grid. CPUE CV was fixed for all indices. 

```{r, results="asis"}
# Make summary table
dat <- apply(SWOMSE::OMs_DF[,1:7], 2, unique)
maxlen <- lapply(dat, length) %>% unlist() %>% max()
dat$env <- as.logical(dat$env)
for (i in seq_along(dat)) {
  tt <- dat[[i]]
  if (length(tt) < maxlen) {
    tt <- c(tt, rep(NA, maxlen - length(tt)))
  }
  dat[[i]] <- tt
}
df <- data.frame(matrix(unlist(dat), ncol=length(dat), byrow=FALSE))
names(df) <- names(dat)
df$env <- as.logical(df$env)
df[is.na(df)] <- ''
# df$llq[df$llq == '1'] <- 'FALSE'

rownames(df) <- NULL
df2 <- df
col.names <- c("M", 'sigmaR', 'h', 'CPUE CV', 'Len. Comp. Eff. Samp. Size', 'Q increase', 'Env. Covariate')
colnames(df2) <- col.names

df2 %>% knitr::kable(escape=FALSE) %>%
  kableExtra::kable_styling() 
 
```

# Convergence 
All 288 OMs in the uncertainty grid converged (invertible hessian).

# Check for Parameters at Bounds

```{r}
DF_bound <- SWOMSE::DF_bound

n.pars <- DF_bound$Parameter %>% unique() %>% length()
n.OMs <- DF_bound$OM %>% unique() %>% length()

```

 `r n.OMs` OMs had parameters that were close to the specified bounds (defined here as within 1% of the bounds). This only occurred for `r n.pars` parameters, all related to the size-selectivity parameters of the Japan Early and US fishing fleets.  
 
`r tab.cap()` Table of parameters where the estimated values were within 1% of the specified minimum and maximum bounds. Filters at the top of each column can be used to subset the results. The table can be downloaded as a CSV file using the 'CSV' button.

```{r, results='asis'}
link <- paste0("https://github.com/ICCAT/nswo-mse/raw/master/docs/Reports/OM_Summary/Table", tab.num, ".csv")
if (knitr::is_latex_output()) {
  cat('NOTE: Dynamic tables are only available in HTML version of this report. Click [here](', link, ')^[', link, '] to download the table in CSV format (After opening link, right-click and Save As .csv).')
}
```

```{r}
DF_bound$OM <- as.factor(DF_bound$OM)
write.csv(DF_bound, file=file.path(getwd(), paste0('../../docs/Reports/OM_Summary/Table', tab.num, '.csv')))
DT::datatable(DF_bound, filter='top', 
              extensions = 'Buttons',
              options = list(
                dom = 'Blfrtip',
                buttons = list(list(extend = 'csv', filename= 'ParameterBounds')),
                pageLength = 10,
                columnDefs = list(list(width = '200px', targets = "_all"))),
              rownames = FALSE,
              escape=FALSE
              )

```

```{r, fig.width=8, fig.height=6}

basecase_DF <- SWOMSE::basecase_DF
basecase_DF$n <- as.character(basecase_DF$n)
basecase_DF$dir <- as.character(basecase_DF$dir)

basecase_DF$se_log <- mean(basecase_DF$se_log)
basecase_DF <- basecase_DF %>% dplyr::distinct()
basecase_DF$llq <- 1.00

OMs_DF <- SWOMSE::OMs_DF
OMs_DF$n <- as.character(OMs_DF$n)
OMs_DF$dir <- as.character(OMs_DF$dir)
allOMs <- dplyr::bind_rows(basecase_DF, OMs_DF) 

OMdf <- allOMs %>% dplyr::select(OM=n, M, sigmaR, h, se_log, L_ESS, llq, env, conv)
OMdf <- lapply(OMdf, factor) %>% as.data.frame()

lev.ord <- c(levels(OMdf$OM)[length(OMdf$OM)], sort(as.numeric(levels(OMdf$OM)[1:(length(levels(OMdf$OM))-1)])))
OMdf$OM<- factor(OMdf$OM, levels=lev.ord, ordered = TRUE)

OMdf2 <- OMdf
colnames(OMdf2) <- c("OM", col.names, "conv")
OMdf3 <- OMdf2 

TSBio_List <- SWOMSE::TSBio_List

for (i in seq_along(TSBio_List)) {
  TSBio_List[[i]]$OM <- as.character(i)
}

TSBio_DF <- do.call('rbind', TSBio_List)
TSBio_DF <- suppressWarnings(dplyr::left_join(TSBio_DF, OMdf, by="OM"))
TSBio_DF <- TSBio_DF %>% dplyr::filter(conv==TRUE, year %in% 1950:2018)

BaseCase <- SWOMSE::basecase_TSbio %>% dplyr::filter(year %in% 1950:2018)

nms <- c('M', 'sigmaR', 'h', 'se_log', 'L_ESS', 'llq', 'env')
labs <- c('Natural Mortality (M)', 'Rec. Var. (sigmaR)', 
          'Steepness (h)', "CV Indices", 'Len. Comp. ESS', 'Q Inc.', 'Env. Cov.')



TSBio_DF$OM_bound <- FALSE
TSBio_DF$OM_bound[TSBio_DF$OM %in% DF_bound$OM] <- TRUE

Stock_Status <- TSBio_DF %>% dplyr::filter(year==max(year))

ggplot(Stock_Status, aes(x=B.Bmsy, fill=OM_bound)) + 
  geom_histogram(binwidth =0.1) +
  labs(x="B/BMSY", fill="OM Parameters near bound") +
  theme_bw() +
  ggplot2::expand_limits(x=c(0, 0))

```

`r fig.cap()` Histogram of the estimated stock status (B/BMSY) in 2017 with colours showing the OMs with some selectivity parameters close to the bounds. 

```{r, fig.width=8, fig.height=6}
ggplot(TSBio_DF, aes(x=year, y=B.Bmsy, group=OM, color=OM_bound)) + 
  geom_line() +
  labs(x="Year", y="B/BMSY", color="OM Parameters near bound") +
  theme_bw() + 
  geom_hline(yintercept=1, linetype='dashed') + 
  ggplot2::expand_limits(y=c(0, 0)) 
  
```

`r fig.cap()` Time-series plot of B/BMSY with colours showing the OMs with some selectivity parameters close to the bounds.  B/BMSY = 1 is shown as a dashed black line.  


# Parameter and Likelihood Table

`r tab.cap()` The parameters and the total and component negative log-likelihood values for the base case model and the 288 OMs from the uncertainty grid. Filters at the top of each column can be used to subset the results. The table can be downloaded as a CSV file using the 'CSV' button.

```{r, results='asis'}
link <- paste0("https://github.com/ICCAT/nswo-mse/raw/master/docs/Reports/OM_Summary/Table", tab.num, ".csv")
if (knitr::is_latex_output()) {
  cat('NOTE: Dynamic tables are only available in HTML version of this report. Click [here](', link, ')^[', link, '] to download the table in CSV format (After opening link, right-click and Save As .csv).')
}
```

```{r}
# Summary of OM 


# likelihood table
dflist <- list()
dflist[[1]] <- data.frame(OM='base_case', SWOMSE::basecase_LH[[1]][1,])
for (i in seq_along(SWOMSE::Like_List)) {
  dflist[[i+1]] <- data.frame(OM=as.character(i), SWOMSE::Like_List[[i]][[1]][1,])
}
lkDF <- do.call('rbind', dflist)
rownames(lkDF) <- NULL
ind <- which(OMdf$conv == TRUE)
lkDF <- lkDF[ind,]
lkDF <- lkDF %>% dplyr::select(OM, Total=TOTAL, Survey, Mean_body_wt, Length_comp,
                           Recruitment)

joinedDF <- suppressWarnings(dplyr::left_join(OMdf2, lkDF, by="OM"))
joinedDF$conv <- NULL
par_nm <- names(OMdf2)
par_nm <- par_nm[1:(length(par_nm)-1)]
lk_nm <- names(lkDF)[2:length(lkDF)]


col_groups <- htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(colspan = length(par_nm), style = "border-right: dashed 2px;", 'Parameter Values'),
      th(colspan = length(lk_nm), 'Likelihood Values')
    ),
    tr(
      lapply(par_nm[1:(length(par_nm)-1)], th),
      th(style = "border-right: dashed 2px;", par_nm[length(par_nm)]),
      lapply(lk_nm, th),
    )
  )
))
  
n.col <- 500
colfun <-  colorRampPalette(c("green", "lightgreen", "yellow", "orange", "red"))
values <- colfun(n.col)
rng <- range(joinedDF$Total)
cuts <- seq(rng[1], rng[2], length.out=n.col-1)

write.csv(joinedDF, file=file.path(getwd(), paste0('../../docs/Reports/OM_Summary/Table', tab.num, '.csv')))
DT::datatable(joinedDF, filter='top', 
              extensions = 'Buttons',
              options = list(
                dom = 'Blfrtip',
                buttons = list(list(extend = 'csv', filename= 'LikelihoodValues')),
                pageLength = 10,
                columnDefs = list(list(width = '200px', targets = "_all"))),
              rownames = FALSE,
              escape=FALSE,
              container = col_groups) %>% 
  DT::formatStyle('Total', 
                  backgroundColor = DT::styleInterval(cuts, values),
                  `border-left` = "dashed 2px")
  

```


# Reference Points Table

```{r}
basecase_RefPoint <- SWOMSE::basecase_RefPoint
basecase_RefPoint$n <- as.character(basecase_RefPoint$n)
RefPoint_DF <- SWOMSE::RefPoint_DF
RefPoint_DF$n <- as.character(RefPoint_DF$n)

ref_pointDF <- dplyr::bind_rows(basecase_RefPoint,
                                RefPoint_DF)
ref_pointDF$n <- factor(ref_pointDF$n, levels=c("base_case", 1:288), ordered=TRUE)

ref_pointDF2 <- ref_pointDF
col.names <- c("OM", "MSY", "SB, sub('MSY')", 'F<sub>MSY</sub>', 'F/F<sub>MSY</sub>', 
               'SB/SB<sub>MSY</sub>',
               'SBM<sub>MSY</sub>/SB<sub>0</sub>', 'Depletion')
colnames(ref_pointDF) <- col.names


ind <- which(OMdf$conv == TRUE)
ref_pointDF <- ref_pointDF[ind,]
ref_pointDF[,-1] <-round(ref_pointDF[,-1],2) #the "-1" excludes column 1
```

`r tab.cap()` Summary table of the biological reference points for the base case model and the `r nrow(ref_pointDF)-1` models from the uncertainty grid. Filters at the top of each column can be used to subset the results. The table can be downloaded as a CSV file using the 'CSV' button.

```{r, results='asis'}
link <- paste0("https://github.com/ICCAT/nswo-mse/raw/master/docs/Reports/OM_Summary/Table", tab.num, ".csv")
if (knitr::is_latex_output()) {
  cat('NOTE: Dynamic tables are only available in HTML version of this report. Click [here](', link, ')^[', link, '] to download the table in CSV format (After opening link, right-click and Save As .csv).')
}
```

```{r}

joinedDF <- suppressWarnings(dplyr::left_join(OMdf2, ref_pointDF, by="OM"))
joinedDF$conv <- NULL

ref_nm <- names(ref_pointDF)[2:length(names(ref_pointDF))]

col_groups <- htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(colspan = length(par_nm), style = "border-right: dashed 2px;", 'Parameter Values'),
      th(colspan = length(ref_nm), 'Reference Points')
    ),
    tr(
      lapply(par_nm[1:(length(par_nm)-1)], th),
      th(style = "border-right: dashed 2px;", par_nm[length(par_nm)]),
      th("MSY"),
      th(shiny::HTML(paste0("SB", tags$sub("MSY")))),
      th(shiny::HTML(paste0("F", tags$sub("MSY")))),
      th(shiny::HTML(paste0("F/F", tags$sub("MSY")))),
      th(shiny::HTML(paste0("SB/SB", tags$sub("MSY")))),
      th(shiny::HTML(paste0("SB",tags$sub("MSY"), "/SB", tags$sub("0")))),
      th("Depletion")
    )
  )
))

write.csv(joinedDF, file=file.path(getwd(), paste0('../../docs/Reports/OM_Summary/Table', tab.num, '.csv')))
DT::datatable(joinedDF, filter='top', 
              extensions = 'Buttons',
              options = list(
                dom = 'Blfrtip',
                buttons = list(list(extend = 'csv', filename= 'ReferencePoints')),
                pageLength = 10,
                columnDefs = list(list(width = '200px', targets = "_all"))),
              rownames = FALSE,
              escape=FALSE,
              container = col_groups) %>%
 DT::formatStyle('MSY', `border-left` = "dashed 2px")
 
```



```{r, include=FALSE, warning=FALSE}
TS_LikeDF <- dplyr::left_join(TSBio_DF, lkDF, by="OM")

```

# Negative Log-Likelihood Plots
The negative log-likelihood (NLL) values are not directly comparable across the OMs due to different data and assumptions used in the models. 

For example, Figures `r fig.num+1` and `r fig.num+2`  show histograms of the Total NLL and NLL of the length composition data  for the 288 OMs with colours indicating the effective sample size of the length composition. 


```{r, fig.width=8, fig.height=6}
ggplot2::ggplot(TS_LikeDF %>% filter(year==max(year))) +
  ggplot2::geom_histogram(ggplot2::aes(x=Total, fill=L_ESS), binwidth = 25) +
  ggplot2::labs(x='Total NLL', fill=labs[match('L_ESS', nms)]) +
  ggplot2::theme_bw()

```

`r fig.cap()` Histogram of the total negative log-likelihood (NLL) with filled colours
indicating the two values for the effective sample size for the length composition (Len. Comp. ESS).

```{r, fig.width=8, fig.height=6}
ggplot2::ggplot(TS_LikeDF %>% filter(year==max(year))) +
  ggplot2::geom_histogram(ggplot2::aes(x=Length_comp, fill=L_ESS), binwidth = 25) +
  ggplot2::labs(x='NLL Length Composition', fill=labs[match('L_ESS', nms)]) +
  ggplot2::theme_bw()

```

`r fig.cap()` Histogram of the NLL for the length composition data with filled colours
indicating the two values for the effective sample size for the length composition (Len. Comp. ESS).

## Comparing Model Fits to Length Composition Data

To compare the fits to the length composition data the NLL of the length composition with effective sample size 2 was up-weighted by a factor of 10 (Figure `r fig.num+1`). Figure `r fig.num+2` shows a histogram of the estimated 2017 stock status with colours indicating 4 discrete levels of the up-weighted NLL for the length composition.

````{r, fig.width=8, fig.height=6}
# up-weight comp data 
TS_LikeDF$Length_comp_weighted <- TS_LikeDF$Length_comp
TS_LikeDF$Length_comp_weighted[TS_LikeDF$L_ESS==2] <- TS_LikeDF$Length_comp_weighted[TS_LikeDF$L_ESS==2] * 10 

ggplot2::ggplot(TS_LikeDF %>% filter(year==max(year))) +
  ggplot2::geom_histogram(ggplot2::aes(x=Length_comp_weighted, fill=L_ESS), binwidth = 25) +
  ggplot2::labs(x='NLL (up-weighted) Length Composition', fill=labs[match('L_ESS', nms)]) +
  ggplot2::theme_bw()

```

`r fig.cap()` Histogram of the NLL for the length composition data, where NLL for effective sample size 2 was up-weighted by a factor of 10, with filled colours indicating the two values for the effective sample size for the length composition (Len. Comp. ESS).

```{r,  fig.width=8, fig.height=6}

nbins <- 5
bins <- seq(from=floor(min(TS_LikeDF$Length_comp_weighted)), 
            to=ceiling(max(TS_LikeDF$Length_comp_weighted)), length.out=nbins)
TS_LikeDF$Length_comp_NLL_weighted_discrete <- cut(TS_LikeDF$Length_comp_weighted, bins)

ggplot2::ggplot(TS_LikeDF %>% filter(year==max(year))) +
  ggplot2::geom_histogram(ggplot2::aes(x=B.Bmsy, fill=Length_comp_NLL_weighted_discrete), binwidth = 0.05) +
  ggplot2::theme_bw() +
  labs(x="B/BMSY", fill="NLL (up-weighted) Fit to Length Composition")

```

`r fig.cap()` Histogram of estimated stock status (B/BMSY) in 2017 for the length composition data, where NLL for effective sample size 2 was up-weighted by a factor of 10, and NLL values grouped into 4 discrete classes.



# SB/SB~MSY~ Timeseries Plots

Time-series plots of the spawning biomass (SB) relative to spawning biomass corresponding with maximum sustainable yield (SB~MSY~) for the seven factors examined in the uncertainty grid.


## Natural Mortality

```{r, fig.width=8, fig.height=6}
bcsize <- 1.1
col <- 'M'
collab <- labs[match(col, nms)]
ggplot2::ggplot(TSBio_DF) + 
  ggplot2::geom_hline(yintercept = 1, linetype=2) +
  ggplot2::geom_line(ggplot2::aes(x=year, y= B.Bmsy, 
                                       color=as.factor(get(col)),
                                       group=OM)) +
   ggplot2::geom_line(data=BaseCase,
                      ggplot2::aes(x=year, y= B.Bmsy),
                      color='black', size=bcsize)+
  ggplot2::expand_limits(y=c(0, 0)) +
  ggplot2::theme_bw() +
  ggplot2::labs(x="Year", y=expression(SB/SB[MSY]),
                color=collab)
````

`r fig.cap()` Predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the `r TSBio_DF[[col]] %>% unique() %>% length()` levels of `r collab` shown as coloured lines. The base case OM is shown as the thick black line. 


## Recruitment Variability
```{r, fig.width=8, fig.height=6}
col <- 'sigmaR'
collab <- labs[match(col, nms)]
ggplot2::ggplot(TSBio_DF) + 
  ggplot2::geom_hline(yintercept = 1, linetype=2) +
  ggplot2::geom_line(ggplot2::aes(x=year, y= B.Bmsy, 
                                       color=as.factor(get(col)),
                                       group=OM)) +
   ggplot2::geom_line(data=BaseCase,
                      ggplot2::aes(x=year, y= B.Bmsy),
                      color='black', size=bcsize)+
  ggplot2::expand_limits(y=c(0, 0)) +
  ggplot2::theme_bw() +
  ggplot2::labs(x="Year", y=expression(SB/SB[MSY]),
                color=collab)
````

`r fig.cap()` Predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the `r TSBio_DF[[col]] %>% unique() %>% length()` levels of `r collab` shown as coloured lines. The base case OM is shown as the thick black line. 

## Steepness
```{r, fig.width=8, fig.height=6}
col <- 'h'
collab <- labs[match(col, nms)]
ggplot2::ggplot(TSBio_DF) + 
  ggplot2::geom_hline(yintercept = 1, linetype=2) +
  ggplot2::geom_line(ggplot2::aes(x=year, y= B.Bmsy, 
                                       color=as.factor(get(col)),
                                       group=OM)) +
   ggplot2::geom_line(data=BaseCase,
                      ggplot2::aes(x=year, y= B.Bmsy),
                      color='black', size=bcsize)+
  ggplot2::expand_limits(y=c(0, 0)) +
  ggplot2::theme_bw() +
  ggplot2::labs(x="Year", y=expression(SB/SB[MSY]),
                color=collab)
````

`r fig.cap()` Predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the `r TSBio_DF[[col]] %>% unique() %>% length()` levels of `r collab` shown as coloured lines.

## CPUE CV
```{r, fig.width=8, fig.height=6}
col <- 'se_log'
collab <- labs[match(col, nms)]
ggplot2::ggplot(TSBio_DF) + 
  ggplot2::geom_hline(yintercept = 1, linetype=2) +
  ggplot2::geom_line(ggplot2::aes(x=year, y= B.Bmsy, 
                                       color=as.factor(get(col)),
                                       group=OM)) +
   ggplot2::geom_line(data=BaseCase,
                      ggplot2::aes(x=year, y= B.Bmsy),
                      color='black', size=bcsize)+
  ggplot2::expand_limits(y=c(0, 0)) +
  ggplot2::theme_bw() +
  ggplot2::labs(x="Year", y=expression(SB/SB[MSY]),
                color=collab)
````

`r fig.cap()` Predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the `r TSBio_DF[[col]] %>% unique() %>% length()` levels of `r collab` shown as coloured lines. The base case OM is shown as the thick black line. 

## Length Comp. ESS
```{r, fig.width=8, fig.height=6}
col <- 'L_ESS'
collab <- labs[match(col, nms)]
ggplot2::ggplot(TSBio_DF) + 
  ggplot2::geom_hline(yintercept = 1, linetype=2) +
  ggplot2::geom_line(ggplot2::aes(x=year, y= B.Bmsy, 
                                       color=as.factor(get(col)),
                                       group=OM)) +
   ggplot2::geom_line(data=BaseCase,
                      ggplot2::aes(x=year, y= B.Bmsy),
                      color='black', size=bcsize)+
  ggplot2::expand_limits(y=c(0, 0)) +
  ggplot2::theme_bw() +
  ggplot2::labs(x="Year", y=expression(SB/SB[MSY]),
                color=collab)
````

`r fig.cap()` Predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the `r TSBio_DF[[col]] %>% unique() %>% length()` levels of `r collab` shown as coloured lines. The base case OM is shown as the thick black line. 


## Catchability Increase 
```{r, fig.width=8, fig.height=6}
col <- 'llq'
collab <- labs[match(col, nms)]
ggplot2::ggplot(TSBio_DF) + 
  ggplot2::geom_hline(yintercept = 1, linetype=2) +
  ggplot2::geom_line(ggplot2::aes(x=year, y= B.Bmsy, 
                                       color=as.factor(get(col)),
                                       group=OM)) +
   ggplot2::geom_line(data=BaseCase,
                      ggplot2::aes(x=year, y= B.Bmsy),
                      color='black', size=bcsize)+
  ggplot2::expand_limits(y=c(0, 0)) +
  ggplot2::theme_bw() +
  ggplot2::labs(x="Year", y=expression(SB/SB[MSY]),
                color=collab)
````

`r fig.cap()` Predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the `r TSBio_DF[[col]] %>% unique() %>% length()` levels of `r collab` shown as coloured lines. The base case OM is shown as the thick black line. 

## Environmental Covariate
```{r, fig.width=8, fig.height=6}
col <- 'env'
collab <- labs[match(col, nms)]
ggplot2::ggplot(TSBio_DF) + 
  ggplot2::geom_hline(yintercept = 1, linetype=2) +
  ggplot2::geom_line(ggplot2::aes(x=year, y= B.Bmsy, 
                                       color=as.factor(get(col)),
                                       group=OM)) +
   ggplot2::geom_line(data=BaseCase,
                      ggplot2::aes(x=year, y= B.Bmsy),
                      color='black', size=bcsize)+
  ggplot2::expand_limits(y=c(0, 0)) +
  ggplot2::theme_bw() +
  ggplot2::labs(x="Year", y=expression(SB/SB[MSY]),
                color=collab)
````

`r fig.cap()` Predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the `r TSBio_DF[[col]] %>% unique() %>% length()` levels of `r collab` shown as coloured lines.

# Current SB/SB~MSY~ Histograms

## Natural Mortality

```{r, fig.width=8, fig.height=6}
Stock_Status <- TSBio_DF %>% dplyr::filter(year==max(year))

col <- 'M'
collab <- labs[match(col, nms)]
ggplot2::ggplot(Stock_Status) + 
  ggplot2::geom_histogram(ggplot2::aes(x= B.Bmsy, 
                                       fill=as.factor(get(col))
                                       ), binwidth = 0.1) +
  ggplot2::geom_vline(xintercept = 1, linetype=2) +
  ggplot2::expand_limits(x=c(0, 0)) +
  ggplot2::theme_bw() +
  ggplot2::labs(x=expression(SB/SB[MSY]- 2017),
                fill=collab)

n.level <- Stock_Status[col] %>% unique() %>% nrow()

```

`r fig.cap()` Histogram of predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the `r n.level` levels of `r collab`.

## Recruitment Variability 

```{r, fig.width=8, fig.height=6}
Stock_Status <- TSBio_DF %>% dplyr::filter(year==max(year))

col <- 'sigmaR'
collab <- labs[match(col, nms)]
ggplot2::ggplot(Stock_Status) + 
  ggplot2::geom_histogram(ggplot2::aes(x= B.Bmsy, 
                                       fill=as.factor(get(col))
                                       ), binwidth = 0.1) +
  ggplot2::geom_vline(xintercept = 1, linetype=2) +
  ggplot2::expand_limits(x=c(0, 0)) +
  ggplot2::theme_bw() +
  ggplot2::labs(x=expression(SB/SB[MSY]- 2017),
                fill=collab)

n.level <- Stock_Status[col] %>% unique() %>% nrow()

```

`r fig.cap()` Histogram of predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the `r n.level` levels of `r collab`.

## Steepness

```{r, fig.width=8, fig.height=6}
Stock_Status <- TSBio_DF %>% dplyr::filter(year==max(year))

col <- 'h'
collab <- labs[match(col, nms)]
ggplot2::ggplot(Stock_Status) + 
  ggplot2::geom_histogram(ggplot2::aes(x= B.Bmsy, 
                                       fill=as.factor(get(col))
                                       ), binwidth = 0.1) +
  ggplot2::geom_vline(xintercept = 1, linetype=2) +
  ggplot2::expand_limits(x=c(0, 0)) +
  ggplot2::theme_bw() +
  ggplot2::labs(x=expression(SB/SB[MSY]- 2017),
                fill=collab)

n.level <- Stock_Status[col] %>% unique() %>% nrow()

```

`r fig.cap()` Histogram of predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the `r n.level` levels of `r collab`.

## CPUE CV


```{r, fig.width=8, fig.height=6}
Stock_Status <- TSBio_DF %>% dplyr::filter(year==max(year))

col <- 'se_log'
collab <- labs[match(col, nms)]
ggplot2::ggplot(Stock_Status) + 
  ggplot2::geom_histogram(ggplot2::aes(x= B.Bmsy, 
                                       fill=as.factor(get(col))
                                       ), binwidth = 0.1) +
  ggplot2::geom_vline(xintercept = 1, linetype=2) +
  ggplot2::expand_limits(x=c(0, 0)) +
  ggplot2::theme_bw() +
  ggplot2::labs(x=expression(SB/SB[MSY]- 2017),
                fill=collab)

n.level <- Stock_Status[col] %>% unique() %>% nrow()

```

`r fig.cap()` Histogram of predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the `r n.level` levels of `r collab`.

## Length Comp. ESS


```{r, fig.width=8, fig.height=6}
Stock_Status <- TSBio_DF %>% dplyr::filter(year==max(year))

col <- 'L_ESS'
collab <- labs[match(col, nms)]
ggplot2::ggplot(Stock_Status) + 
  ggplot2::geom_histogram(ggplot2::aes(x= B.Bmsy, 
                                       fill=as.factor(get(col))
                                       ), binwidth = 0.1) +
  ggplot2::geom_vline(xintercept = 1, linetype=2) +
  ggplot2::expand_limits(x=c(0, 0)) +
  ggplot2::theme_bw() +
  ggplot2::labs(x=expression(SB/SB[MSY]- 2017),
                fill=collab)

n.level <- Stock_Status[col] %>% unique() %>% nrow()

```

`r fig.cap()` Histogram of predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the `r n.level` levels of `r collab`.

## Catchability Increase

```{r, fig.width=8, fig.height=6}
Stock_Status <- TSBio_DF %>% dplyr::filter(year==max(year))

col <- 'llq'
collab <- labs[match(col, nms)]
ggplot2::ggplot(Stock_Status) + 
  ggplot2::geom_histogram(ggplot2::aes(x= B.Bmsy, 
                                       fill=as.factor(get(col))
                                       ), binwidth = 0.1) +
  ggplot2::geom_vline(xintercept = 1, linetype=2) +
  ggplot2::expand_limits(x=c(0, 0)) +
  ggplot2::theme_bw() +
  ggplot2::labs(x=expression(SB/SB[MSY]- 2017),
                fill=collab)

n.level <- Stock_Status[col] %>% unique() %>% nrow()

```

`r fig.cap()` Histogram of predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the `r n.level` levels of `r collab`.


## Environmental Covariate

```{r, fig.width=8, fig.height=6}
Stock_Status <- TSBio_DF %>% dplyr::filter(year==max(year))

col <- 'env'
collab <- labs[match(col, nms)]
ggplot2::ggplot(Stock_Status) + 
  ggplot2::geom_histogram(ggplot2::aes(x= B.Bmsy, 
                                       fill=as.factor(get(col))
                                       ), binwidth = 0.1) +
  ggplot2::geom_vline(xintercept = 1, linetype=2) +
  ggplot2::expand_limits(x=c(0, 0)) +
  ggplot2::theme_bw() +
  ggplot2::labs(x=expression(SB/SB[MSY]- 2017),
                fill=collab)

n.level <- Stock_Status[col] %>% unique() %>% nrow()

```

`r fig.cap()` Histogram of predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the `r n.level` levels of `r collab`.


# Current SB/SB~MSY~ Bi-Variate Boxplots

Bivariate boxplots of the spawning biomass (SB) relative to spawning biomass corresponding with maximum sustainable yield (SB~MSY~) for the factors examined in the uncertainty grid.  


```{r, include=FALSE}
ind <- which(OMdf$conv == TRUE)
OMdf2 <- OMdf[ind,]
OMdf2$M <- OMdf2$M %>% as.character() %>% as.numeric()
OMdf2$sigmaR <- OMdf2$sigmaR %>% as.character() %>% as.numeric()
OMdf2$h <- OMdf2$h %>% as.character() %>% as.numeric()
OMdf2$se_log <- OMdf2$se_log %>% as.character() %>% as.numeric()

combDF <- dplyr::left_join(OMdf2, ref_pointDF, by='OM')
combDF <- combDF %>% dplyr::filter(OM !='base_case')

gg <- expand.grid(nms, nms)
gg$check <- TRUE
gg$check[gg$Var1 == gg$Var2] <- FALSE
gg <- gg %>% dplyr::filter(check==TRUE)
gg$check <- NULL

gg <- gg[duplicated(t(apply(gg, 1, sort))),]
gg <- gg %>% dplyr::arrange(Var1)

combDF$SB_SBMSY <- combDF$`SB/SB<sub>MSY</sub>`
y <- 'SB_SBMSY'
ylab <- expression(SB/SB[MSY])
  
```

## Natural Mortality 


```{r}
ind <- which(gg$Var1 == "M")
nrow <- ceiling(length(ind)/2)
ncol <- ceiling(length(ind)/nrow)

width <- 8
height <- 2*nrow
```

```{r, fig.width=width, fig.height=height}
Plist <- lapply(ind, function(i) {
  x <- gg$Var1[i] %>% as.character()
  xlab <- labs[match(x, nms)]
  fill <- gg$Var2[i] %>% as.character()
  filllab <- labs[match(fill, nms)]
  
  ggplot2::ggplot(combDF,
                  ggplot2::aes(x=as.factor(get(x)),
                               y=get(y),
                               fill=as.factor(get(fill)))) +
    ggplot2::geom_hline(yintercept = 1, linetype=2)+
    ggplot2::geom_boxplot() +
    ggplot2::expand_limits(y=c(0,1)) +
    ggplot2::theme_classic() +
    ggplot2::labs(x=xlab, y=ylab, fill=filllab)
})

cowplot::plot_grid(plotlist=Plist, nrow=nrow, ncol=ncol, align='hv')

```

`r fig.cap()` Boxplots of predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the 3 levels of Natural Mortality shown as factors on the x-axis and colours indicating the other factors.


## Recruitment Variability

```{r}
ind <- which(gg$Var1 == "sigmaR")
nrow <- ceiling(length(ind)/2)
ncol <- ceiling(length(ind)/nrow)

width <- 4*ncol
height <- 2*nrow
```

```{r, fig.width=width, fig.height=height}

Plist <- lapply(ind, function(i) {
  x <- gg$Var1[i] %>% as.character()
  xlab <- labs[match(x, nms)]
  fill <- gg$Var2[i] %>% as.character()
  filllab <- labs[match(fill, nms)]
  ggplot2::ggplot(combDF,
                  ggplot2::aes(x=as.factor(get(x)),
                               y=get(y),
                               fill=as.factor(get(fill)))) +
    ggplot2::geom_hline(yintercept = 1, linetype=2)+
    ggplot2::geom_boxplot() +
    ggplot2::expand_limits(y=c(0,1)) +
    ggplot2::theme_classic() +
    ggplot2::labs(x=xlab, y=ylab, fill=filllab)
})

cowplot::plot_grid(plotlist=Plist, nrow=nrow, ncol=ncol, align='hv')
```

`r fig.cap()` Boxplots of predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the 2 levels of Recruitment Variability shown as factors on the x-axis and colours indicating the other factors.

## Steepness

```{r}
ind <- which(gg$Var1 == "h")
nrow <- ceiling(length(ind)/2)
ncol <- ceiling(length(ind)/nrow)

width <- 4*ncol
height <- 2*nrow
```

```{r, fig.width=width, fig.height=height}

Plist <- lapply(ind, function(i) {
  x <- gg$Var1[i] %>% as.character()
  xlab <- labs[match(x, nms)]
  fill <- gg$Var2[i] %>% as.character()
  filllab <- labs[match(fill, nms)]
  ggplot2::ggplot(combDF,
                  ggplot2::aes(x=as.factor(get(x)),
                               y=get(y),
                               fill=as.factor(get(fill)))) +
    ggplot2::geom_hline(yintercept = 1, linetype=2)+
    ggplot2::geom_boxplot() +
    ggplot2::expand_limits(y=c(0,1)) +
    ggplot2::theme_classic() +
    ggplot2::labs(x=xlab, y=ylab, fill=filllab)
})

cowplot::plot_grid(plotlist=Plist, nrow=nrow, ncol=ncol, align='hv')


```

`r fig.cap()` Boxplots of predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the 3 levels of Steepness shown as factors on the x-axis and colours indicating the other factors.

## CPUE CV

```{r}
ind <- which(gg$Var1 == "se_log")
nrow <- ceiling(length(ind)/2)
ncol <- ceiling(length(ind)/nrow)

width <- 4*ncol
height <- 2*nrow
```

```{r, fig.width=width, fig.height=height}

Plist <- lapply(ind, function(i) {
  x <- gg$Var1[i] %>% as.character()
  xlab <- labs[match(x, nms)]
  fill <- gg$Var2[i] %>% as.character()
  filllab <- labs[match(fill, nms)]
  ggplot2::ggplot(combDF,
                  ggplot2::aes(x=as.factor(get(x)),
                               y=get(y),
                               fill=as.factor(get(fill)))) +
    ggplot2::geom_hline(yintercept = 1, linetype=2)+
    ggplot2::geom_boxplot() +
    ggplot2::expand_limits(y=c(0,1)) +
    ggplot2::theme_classic() +
    ggplot2::labs(x=xlab, y=ylab, fill=filllab)
})

cowplot::plot_grid(plotlist=Plist, nrow=nrow, ncol=ncol, align='hv')


```

`r fig.cap()` Boxplots of predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the 2 levels of CV Indices shown as factors on the x-axis and colours indicating the other factors.

## Length Comp. ESS

```{r}
ind <- which(gg$Var1 == "L_ESS")
nrow <- ceiling(length(ind)/2)
ncol <- ceiling(length(ind)/nrow)

width <- 4*ncol
height <- 2*nrow
```

```{r, fig.width=width, fig.height=height}

Plist <- lapply(ind, function(i) {
  x <- gg$Var1[i] %>% as.character()
  xlab <- labs[match(x, nms)]
  fill <- gg$Var2[i] %>% as.character()
  filllab <- labs[match(fill, nms)]
  ggplot2::ggplot(combDF,
                  ggplot2::aes(x=as.factor(get(x)),
                               y=get(y),
                               fill=as.factor(get(fill)))) +
    ggplot2::geom_hline(yintercept = 1, linetype=2)+
    ggplot2::geom_boxplot() +
    ggplot2::expand_limits(y=c(0,1)) +
    ggplot2::theme_classic() +
    ggplot2::labs(x=xlab, y=ylab, fill=filllab)
})

cowplot::plot_grid(plotlist=Plist, nrow=nrow, ncol=ncol, align='hv')


```

`r fig.cap()` Boxplots of predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the 2 levels of Length Composition Effective Sample Size shown as factors on the x-axis and colours indicating the other factors.

## Catchability Increase


```{r}
ind <- which(gg$Var1 == "llq")
nrow <- ceiling(length(ind)/2)
ncol <- ceiling(length(ind)/nrow)

width <- 4*ncol
height <- 2*nrow
```

```{r, fig.width=width, fig.height=height}
Plist <- lapply(ind, function(i) {
  x <- gg$Var1[i] %>% as.character()
  xlab <- labs[match(x, nms)]
  fill <- gg$Var2[i] %>% as.character()
  filllab <- labs[match(fill, nms)]
  ggplot2::ggplot(combDF,
                  ggplot2::aes(x=as.factor(get(x)),
                               y=get(y),
                               fill=as.factor(get(fill)))) +
    ggplot2::geom_hline(yintercept = 1, linetype=2)+
    ggplot2::geom_boxplot() +
    ggplot2::expand_limits(y=c(0,1)) +
    ggplot2::theme_classic() +
    ggplot2::labs(x=xlab, y=ylab, fill=filllab)
})

cowplot::plot_grid(plotlist=Plist, nrow=nrow, ncol=ncol, align='hv')

```

`r fig.cap()` Boxplots of predicted spawning biomass (SB) relative to spawning biomass at maximum sustainable yield (SB~MSY~) for the `r TSBio_DF$OM %>% unique() %>% length()` OMs from the uncertainty grid with the 2 levels of Q Increase shown as factors on the x-axis and colours indicating the other factors.


# Impact of M and h on Estimated Parameters

## Unfished Recruitment (R0)

```{r include=FALSE}

colnames(ref_pointDF2)[1] <- "OM"
DF <- suppressWarnings(dplyr::left_join(OMdf3, ref_pointDF2, by="OM"))

DF2 <- TSBio_DF %>% dplyr::filter(year==max(year))

DF3 <- suppressWarnings(dplyr::left_join(DF, DF2,
                        by = c("OM", "M", "sigmaR", "h", "conv", "Depletion")))

DF3 <- DF3 %>% dplyr::filter(OM !="base_case")

library(gridExtra)
library(grid)
library(gtable)

addLabels <- function(p, labelR=NULL, labelT=NULL, font.size=14, plot=FALSE) {
  
  z <- ggplotGrob(p)
  
  if (!is.null(labelR)) {
    # Get the positions of the strips in the gtable: t = top, l = left, ..
    posR <- subset(z$layout, grepl("strip-r", name), select = t:r)
    # Add a new column to the right of current right strips, 
    # and a new row on top of current top strips
    width <- z$widths[max(posR$r)]    # width of current right strips
    z <- gtable_add_cols(z, width, max(posR$r))
    # Construct the new strip grobs
    stripR <- gTree(name = "Strip_right", children = gList(
      rectGrob(gp = gpar(col = NA, fill = "white")),
      textGrob(labelR, rot = -90, gp = gpar(fontsize = font.size, col = "grey10"))))
    # Position the grobs in the gtable
    z <- gtable_add_grob(z, stripR, t = min(posR$t), l = max(posR$r)+1, b = max(posR$b), name = "strip-right")
    
    # Add small gaps between strips
    z <- gtable_add_cols(z, unit(1/5, "line"), max(posR$r))
  }
  if (!is.null(labelT)) {
    posT <- subset(z$layout, grepl("strip-t", name), select = t:r)
    height <- z$heights[min(posT$t)]  # height of current top strips
    z <- gtable_add_rows(z, height, min(posT$t)-1)
    
    stripT <- gTree(name = "Strip_top", children = gList(
      rectGrob(gp = gpar(col = NA, fill = "white")),
      textGrob(labelT, gp = gpar(fontsize = font.size, col = "grey10"))))
    z <- gtable_add_grob(z, stripT, t = min(posT$t), l = min(posT$l), r = max(posT$r), name = "strip-top")
    z <- gtable_add_rows(z, unit(1/5, "line"), min(posT$t))
  }
  
  if (plot) grid.draw(z)
  return(invisible(z))
}


```


```{r, fig.width=8, fig.height=6}
p1 <- ggplot(DF3, aes(x=R0)) +
  facet_grid(M~h, scales="free_y") +
  geom_histogram(binwidth = 50) + 
  expand_limits(x=0) +
  theme_bw() +
  labs(x="R0")

p1 <- addLabels(p1, "Natural Mortality (M)", "Steepness (h)")
plot(p1)
```

`r fig.cap()` Histograms of estimated unfished recruitment (R0) faceted by 3 levels of natural mortality (M) and 3 levels of steepness (h). 

## Depletion

```{r, fig.width=8, fig.height=6}
p1 <- ggplot(DF3, aes(x=Depletion)) +
  facet_grid(M~h, scales="free_y") +
  geom_histogram(binwidth = 0.05) + 
  expand_limits(x=c(0,1)) +
  theme_bw() +
  labs(x="Depletion")

p1 <- addLabels(p1, "Natural Mortality (M)", "Steepness (h)")
plot(p1)
```

`r fig.cap()` Histograms of estimated depletion (SB/SB0) faceted by 3 levels of natural mortality (M) and 3 levels of steepness (h). 

## SB~MSY~

```{r, fig.width=8, fig.height=6}
p1 <- ggplot(DF3, aes(x=SBMSY)) +
  facet_grid(M~h, scales="free_y") +
  geom_histogram(binwidth = 10000) + 
  expand_limits(x=c(0,1)) +
  theme_bw() +
  labs(x="SBMSY")

p1 <- addLabels(p1, "Natural Mortality (M)", "Steepness (h)")
plot(p1)
```

`r fig.cap()` Histograms of estimated SB~MSY~ faceted by 3 levels of natural mortality (M) and 3 levels of steepness (h). 


## SSB

```{r, fig.width=8, fig.height=6}
p1 <- ggplot(DF3, aes(x=SSB)) +
  facet_grid(M~h, scales="free_y") +
  geom_histogram(binwidth = 10000) + 
  expand_limits(x=c(0,1)) +
  theme_bw() +
  labs(x="SSB")

p1 <- addLabels(p1, "Natural Mortality (M)", "Steepness (h)")
plot(p1)
```

`r fig.cap()` Histograms of estimated SSB faceted by 3 levels of natural mortality (M) and 3 levels of steepness (h). 

## SB0

```{r, fig.width=8, fig.height=6}
p1 <- ggplot(DF3, aes(x=SB0)) +
  facet_grid(M~h, scales="free_y") +
  geom_histogram(binwidth = 10000) + 
  expand_limits(x=c(0,1)) +
  theme_bw() +
  labs(x="SB0")

p1 <- addLabels(p1, "Natural Mortality (M)", "Steepness (h)")
plot(p1)
```

`r fig.cap()` Histograms of estimated SB0 faceted by 3 levels of natural mortality (M) and 3 levels of steepness (h).






