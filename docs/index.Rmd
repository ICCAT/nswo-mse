---
title: "North Atlantic Swordfish MSE"
author: "Adrian Hordyk <adrian@bluematterscience.com>"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    html_document
---

![](../img/220px-Xiphias_gladius2.jpg)

```{=html}
<style>
  .col2 {
    columns: 2 200px;         /* number of columns and width in pixels*/
    -webkit-columns: 2 200px; /* chrome, safari */
    -moz-columns: 2 200px;    /* firefox */
  }
  .col3 {
    columns: 3 100px;
    -webkit-columns: 3 100px;
    -moz-columns: 3 100px;
  }
  .col4 {
    columns: 4 100px;
    -webkit-columns: 4 100px;
    -moz-columns: 4 100px;
  }
</style>
```
```{r setup, include=FALSE}
library(dplyr)
library(pdftools)
library(SWOMSE)
library(DT)
knitr::opts_chunk$set(echo = FALSE)


```

## Introduction

Welcome to the North Atlantic Swordfish MSE homepage.

This site contains links to documents, reports, and presentations related to the management strategy evaluation (MSE) process for the North Atlantic Swordfish.

The MSE is being conducted with the open-source [openMSE](https://openmse.com/) framework. The code for the swordfish MSE is available in the `SWOMSE` R package available in the [ICCAT GitHub repository](https://github.com/ICCAT/nswo-mse).


## MSE Process Documentation

1. [Trial Specifications Doc](TS/Trial_Specs.html)

2. [CMP Development Guide](cMPdevelopment/CMP-Development-Guide.html)

3. [SWOMSE User Manual](UserManual/User_Manual.html)


## Operating Models

The 2022 stock assessment was used as a base case model for developing the OM grid for the MSE.

An OM uncertainty grid was developed from the base case model using a full factorial design with 6 axes of uncertainty:

1.  Natural mortality (*M*) - three levels: 0.1, 0.2, 0.3

2.  Recruitment variability (sigmaR) - two levels: 0.2, 0.6

3.  Steepness (*h*) - three levels: 0.6, 0.75, 0.90

4.  Relative weight of the indices to the CAL data (cpuelambda) - three levels: 0.05, 1, 20

5.  Directional trend in catchability (q-inc) - two levels: TRUE, FALSE

6.  Environmental covariate (env) - two levels: TRUE, FALSE

This resulted in an OM Uncertainty Grid with 216 operating models. The 2022 Base Case assessment is also included in the `SWOMSE` package.

### OM Summary Report

The [Summary Report](Reports/OM_Summary/2022/OM_Summary_Report.html) summarizes the diagnostic checks, the calculated biological reference points, and the estimated stock status relative to those reference points, across the 216 operating models included in the OM Uncertainty Grid.  

### Individual OM Diagnostic Reports

The searchable table below displays the operating models in the `SWOMSE` package. The operating models can be accessed in the R package by the OM Object name, e.g., `SWOMSE::MOM_000` is the 2022 Base Case Stock Assessment.

Individual OM diagnostic reports can be accessed by clicking the links in the table below. 

```{r}
DF <- SWOMSE::OM_DF
DF$OM.name <- paste0('MOM_',DF$OM.num)
DF <- DF %>% select(OM.name, M, sigmaR, steepness, cpuelambda, llq, env)

DF$env <- as.logical(DF$env)
DF$Comment <- ''
DF$Comment[1] <- '2022 Assessment'
DF <- DF %>% mutate(across(1:6, as.factor))

# create links to OM diagnostic reports
fls <- list.files('Reports/OM_Diagnostics', pattern='.html')
num <- NA
for (x in seq_along(fls)) num[x] <- strsplit(fls[x], '-')[[1]][2]
nums <- as.numeric(num[1:(length(num))])
df <- data.frame(fl=fls, num=nums, stringsAsFactors = FALSE)
df <- df %>% dplyr::arrange(num)
nums <- as.character(df$num)
nums[nchar(nums)==1] <- paste0('00', nums[nchar(nums)==1])
nums[nchar(nums)==2] <- paste0('0', nums[nchar(nums)==2])
df$OM.num <- nums

OM.name <- DF$OM.name %>% as.character()
OM.link <- paste0('<a href=', file.path('Reports/OM_Diagnostics', fls), '> ', OM.name , ' </a>')
DF$OM.name <- OM.link

DT::datatable(DF, escape=1,
              colnames=c('OM Object',
                         'M',
                         'sigmaR',
                         'Steepness (h)',
                         'Relative CPUE Weighting',
                         'Assumed historical increase in catchability',
                         'Include AMO Covariate',
                         'Comment'),
              filter = 'top',
              options = list(
                pageLength = 10, 
                autoWidth = TRUE,
                sDom  = '<"top">lrt<"bottom">ip'))

```


## Related SCRS Papers


```{r, results='asis'}

get_metadata_paper <- function(pdf) {
  page1 <- pdf_data(pdf)[[1]]
  
  lst.head <- which(grepl('(1|2)\\d{3})', page1$text))
  if (!length(lst.head)) {
    lst.head <- 1
  }
  lst.head <-lst.head[1]
  if (lst.head>20) lst.head <- 1
  page1_nohead <- page1[(lst.head+1):nrow(page1),]
  
  ind <- which(grepl("^[[:upper:]]+$", page1_nohead$text))
  
  d <- diff(ind)
  ind <- ind[1:(min(which(d>1))-1)]
  ind <- c(ind, max(ind)+1)
  title <- paste0(page1_nohead$text[ind], collapse = ' ')
  
  scrs <- page1$text[1]
  year <- strsplit(scrs, '/')[[1]][2]
  title <- paste0(title,' (', scrs, ')')
  data.frame(title=title, year=year)
  
}


list.papers <- list.files('./SCRS_Papers/')
list.out <- list()
for (i in seq_along(list.papers)) {
  fl <- list.papers[i]
  link <- file.path('./SCRS_Papers/',fl)
  df <- get_metadata_paper(link)
  df$link <- link
  list.out[[i]] <- df
}
df <- do.call('rbind', list.out)

df <- df %>% dplyr::arrange(desc(year))

for (i in 1:nrow(df)) {
  if (i==1) {
    cat('#### ', df$year[i], '\n', sep="")
  } else {
    if (df$year[i]!=df$year[i-1])
      cat('\n#### ', df$year[i], '\n', sep="")
  }
  cat('\n 1. [', df$title[i], '](', df$link[i], ')', '\n', sep="")
  
}

```


## Meeting Reports


```{r, results='asis'}

get_title_report <- function(pdf) {
  page1 <- pdf_data(pdf)[[1]]
  page1_title <- page1 %>% filter(height >10) 
  begin_ab <- min(which(grepl('\\â€œ', page1_title$text)))
  title <- page1_title$text[1:(begin_ab-1)]
  paste0(title, collapse = ' ')
}


list.reports <- list.files('./Meeting_Reports/')
list.out <- list()
for (i in seq_along(list.reports)) {
  fl <- list.reports[i]
  link <- file.path('./Meeting_Reports/',fl)
  title <- get_title_report(link)
  year <- strsplit(fl, "_")[[1]][1]
  list.out[[i]] <- data.frame(year=year,
                              title=title,
                              link=link)
}
df <- do.call('rbind', list.out)

df <- df %>% dplyr::arrange(desc(year))

for (i in 1:nrow(df)) {
  if (i==1) {
    cat('### ', df$year[i], '\n', sep="")
  } else {
    if (df$year[i]!=df$year[i-1])
      cat('\n### ', df$year[i], '\n', sep="")
  }
  cat('\n 1. [', df$title[i], '](', df$link[i], ')', '\n', sep="")
  
}

```


<br>
<br>
