---
title: "Specificiations for MSE Trials for North Atlantic Swordfish"
author: "Adrian Hordyk <adrian@bluematterscience.com>"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  rmdformats::robobook:
    highlight: kate
    toc_depth: 2
    use_bookdown: yes
  pdf_document:
    toc: yes
header-includes:
- \usepackage{lineno}
- \linenumbers
urlcolor: blue
bibliography: "`r rbbt::bbt_write_bib('biblio.json', overwrite = TRUE)`"
csl: fish-and-fisheries.csl
always_allow_html: true
---

```{css, echo=FALSE}
.csl-entry {
    margin-bottom: 12px;
}
```

```{r, include=FALSE}
library(SWOMSE)
knitr::opts_chunk$set(echo=FALSE)
```


# Introduction

The North Atlantic swordfish fishery, under the management of the [International Commission for the Conservation of Atlantic Tuna](https://www.iccat.int/en/index.asp) (ICCAT), is undergoing a management strategy evaluation (MSE) process. 

ICCAT describes [MSE](https://www.iccat.int/mse/en/index.asp) as:
 
>a collaborative process between Scientists and decision-makers that involves using computer simulation to compare the relative ability to achieve a set of management objectives using alternative Management Strategies, defined as different combinations of data collection schemes, methods of analysis, harvest control rules and subsequent processes leading to management actions.

There are three main components in an MSE process:

1. **Operating models (OMs)**: a collection of mathematical/statistical models that describe alternative hypotheses of the historical fishery dynamics and specifications for simulating the collection of data and implementation of management measures in the future;
2. **Candidate management procedures (CMPs)**: a set of proposed algorithms that generate management recommendations from fishery data, and will be evaluated in the MSE;
3. **Performance metrics (PMs)**: statistics use the quantitatively evaluate the CMPs against specified management objectives.

The operating models, candidate management procedures, and performance metrics are developed as a collaborative effort between scientists, decision-makers, and other stakeholders in the fishery.

## About this document
This document describes the specifications for the OMs, CMPs, and PMs that have been proposed and developed for the North Atlantic swordfish (hereafter swordfish) fishery.

It is a living document and will be continued to be updated so that it reflects the current state of the swordfish MSE process.

Members of the Swordfish Species Group (hereafter the Group) are encouraged to ask questions, provide feedback and comments, and make edits, to any part of this document. 

The document is written using the [Markdown](https://www.markdownguide.org/) format and can edited in any text editor. The source document is available on the [ICCAT/nswo-mse](https://github.com/ICCAT/nswo-mse/blob/master/docs/TS/Trial_Specs.Rmd) GitHub repository. 

The [ICCAT/nswo-mse](https://github.com/ICCAT/nswo-mse) is currently private and only available to members of the Group. Please contact [Adrian Hordyk](mailto:adrian@bluematterscience.com) or [Ai Kimoto](mailto:ai.kimoto@iccat.int) if you do not have access.

Group members can make edits to the document either [directly in the online repository](https://github.com/ICCAT/nswo-mse/edit/master/docs/TS/Trial_Specs.Rmd) or by cloning the repository and submitting [pull requests](https://github.com/ICCAT/nswo-mse/pulls) with their edits. Alternatively, they can email questions or comments to [Adrian](mailto:adrian@bluematterscience.com). The former approach has the advantage that all comments, questions, and edits are immediately visible to all members of the Group.

Group members can also use the [Discussions](https://github.com/ICCAT/nswo-mse/discussions) feature on the Github repository to post questions, comments, or points for discussion related to any aspect of this document or the MSE process in general.

Compiled versions of this document in PDF and HTML format are available at the North Atlantic Swordfish MSE [homepage](https://iccat.github.io/nswo-mse/).


# Stock Assessment
The swordfish operating models are based on the most recent stock assessment of the swordfish fishery [@anon.Report2017ICCAT2017] using Stock Synthesis 3 [SS3, @methotStockSynthesisBiological2013].

The data used in the 2017 assessment, and the structure and assumptions of the assessment model are summarized in the sub-sections below. 

## Data
The assessment used landings data from 8 longline fleets (7 national fleets and 'Other' representing all catches not accounted for in the national fleets) (Table \@ref(tab:fleet-info) and  Figure \@ref(fig:data-fig)). 

There were 6 indices of abundance derived from catch-per-unit-effort (CPUE) data from national fleets (Table \@ref(tab:fleet-info) and  Figure \@ref(fig:data-fig)). Data from the Canada longline fleet was split into two stanzas: Early (1962 - 1970) and Late (1979 - 2016) due to changes in fishing practices that were believed to have changed catchability. Similarly, data from the Japan longline fleet was split into three phases: Early (1974 - 1998), Mid (2006 - 2010), and Late (2011 - 2015) due to changes in fishing practices in these periods. Five additional survey indices were developed from the age-specific (ages estimated from length data) CPUE from the Spain longline fleet (Table \@ref(tab:fleet-info) and  Figure \@ref(fig:data-fig)). 

Length composition data from 7 national fleets (Spain, U.S., Canada (Late), Japan (Early, Mid, Late), Portugal, Chinese-Tapai, and Morocco) and mean weight data from two fleets (U.S. and Canada) was also used (Figure \@ref(fig:data-fig)).

The catchability coefficient (*q*) for the CPUE indices for Canada, Japan, Portugal, Morocco, and the Spain age-specific survey indices, was made a function of the Atlantic Multidecadal Oscillation (AMO) [See @anon.Report2017ICCAT2017 for  details].

The effective sample size (ESS) for the length composition data was established by adjusting ESS until unity was reached between modeled ESS and the Francis suggest sample size  [See @anon.Report2017ICCAT2017 for  details].

```{r fleet-info}
# Year_Info <- Data_DF %>% group_by(Name) %>% filter(is.na(CPUE_Obs)==FALSE) %>%
#   summarize(min=min(year), max=max(year), .groups = 'keep')
# 
# Year_Info$Period <- paste0(Year_Info$min, '-', Year_Info$max)

DF <- Fleet_DF
DF$Code <- gsub("_", '\\\\_', DF$Code)
DF$index <- NULL
DF$Description <- c(
  'Spain longline fleet',
  'US longline observer fleet',
  'Canada longline fleet (early)',
  'Canada longline fleet (later)',
  'Japan fleet (early)',
  'Japan fleet (middle)',
  'Japan fleet (late)',
  'Portugal longline fleet',
  'Chinese-Taipai longline fleet',
  'Morocco longline fleet',
  'All other swordfish fleets',
  'Age-specific CPUE (Spain fleet)',
  'Age-specific CPUE (Spain fleet)',
  'Age-specific CPUE (Spain fleet)',
  'Age-specific CPUE (Spain fleet)',
  'Age-specific CPUE (Spain fleet)'
)
# 
# DF <- left_join(DF, Year_Info %>% select(Name, Period), by="Name")
# 
col.names <- colnames(DF)
# col.names[4] <- 'CPUE Period'
caption <- 'Summary table of the fishing fleets included the 2017 stock assessment of North Atlantic swordfish.'
DF %>% knitr::kable(escape = F,
                    caption=caption,
                    booktabs=TRUE,
                    col.names = col.names) %>%
  kableExtra::kable_styling("striped", full_width = T)

```


```{r data-fig, fig.cap="The time periods for the data used in the model"}
DataSummary <- Data_DF %>% dplyr::select(year, Code, Name, Catch, CPUE_Obs,
                                         Length.Comp, Mean.Weight, year2) %>%
  tidyr::pivot_longer(cols=c('Catch', 'CPUE_Obs', 'Length.Comp', 'Mean.Weight'),
                      names_to = 'Data') %>%
  dplyr::mutate(is.data=ifelse(value>0, TRUE, NA)) %>%
  na.omit()

Data.Names <- c("Catch", 'CPUE', "Length Composition", "Mean Weight")
DataSummary$Data <- factor(DataSummary$Data, labels=Data.Names)

ggplot2::ggplot(DataSummary, ggplot2::aes(year2, Code, color=is.data)) +
  ggplot2::facet_wrap(~Data, ncol=2) +
  ggplot2::geom_line(size=2) +
  ggplot2::labs(y="Fleet", x="Year", color='') +
  ggplot2::scale_color_manual(values='#357DE9') +
  ggplot2::theme_bw()+
  ggplot2::guides(color="none") +
  ggplot2::scale_x_date(breaks=seq.Date(min(DataSummary$year2), max(DataSummary$year2), "5 year"),
               labels = scales::date_format("%Y")) +
  ggplot2::theme(axis.text.x= ggplot2::element_text(angle=45, hjust=1),
        strip.background = ggplot2::element_blank(),
        strip.text = ggplot2::element_text(size=12))
 
```
 
## Model Structure
The SS3 model used one season, one area, and two sexes.

## Fixed Biological Parameters
Natural mortality for both male and female was fixed at 0.2 for all age classes. Maturity-at-age  was knife-edge, with 50% at age-5 and 100% thereafter. Fecundity was proportional to body weight. The growth parameters were fixed at values developed during the 2017 ICCAT Swordfish Data Preparatory Meeting [See @anon.Report2017ICCAT2017 for  details].

## Selectivity
Selectivity was modeled as a function of length. Dome-shaped selectivity was allowed for five fleets: Spain, US, Japan, Portugal, and Morocco. Asymptotic selectivity was assumed for Canada, Chinese-Tapai and 'Other'. The age-specific survey CPUEs were modeled with a fixed age-based selectivity. 

## Stock-Recruitment
Expected recruitment to age-0 was calculated from the total spawning stock biomass using the Beverton-Holt stock-recruit function. The standard error for the log-normally distributed recruitment deviations (sigmaR) was fixed to 0.2. Steepness (*h*) was an estimated parameter, with an informative prior with a Beta distribution, with mean 0.8 and standard deviation (SD) of 0.06. Steepness in the base case model was estaimed at 0.88 (SD = 0.03).

# OM Conditioning
The operating models used in the MSE were developed from the base case assessment model [@anon.Report2017ICCAT2017] with several modifications. 

## Modifications to the Assessment Model 
@schirripaMigratingNorthAtlantic2020 describe the modifications made to the assessment model used to generate the operating models for the MSE. To summarize, there were three main changes to the assessment model:

1. The model was updated to the latest version of the SS3 software (v3.30). The updated version gave essentially identical results to the previous version.

2. The model was modified to explicitly account for the minimum size limit regulation and the impacts of discard mortality. The minimum size regulation was set to 125 cm for the Spain, Canada, Japan and Morocco fleets [@schirripaMigratingNorthAtlantic2020]. The US and Chinese-Taipei fleets had the minimum size limit fixed at 119 cm [@schirripaMigratingNorthAtlantic2020]. Insufficient data exists to estimate discard mortality in the model. The Group decided, based on @coelhoHookingMortalitySwordfish2019, to fix discard mortality at 88%.

3. The models used to generate the operating models had steepness as a fixed parameter rather than estimated internally. 

## OM Uncertainty Grid
> The OMs are currently being conditioned and this section will be updated when the conditioning is complete.

A OM uncertainty grid was developed from the modified SS3 model using a full factorial design with 7 axes of uncertainty:

1. Natural mortality (*h*) - three levels: 0.1, 0.2, 0.3
2. Recruitment variability (sigmaR) - two levels: 0.2, 0.6
3. Steepness (*h*) - three levels: 0.6, 0.75, 0.90
4. CV for the CPUE indices (CPUE CV) - two levels: 0.3, 0.6
5. Length composition effective sample size (ESS) - two levels: 2, 20
6. Directional trend in catchability (q-inc) - two levels: TRUE, FALSE
7. Environmental covariate (env) - two levels: TRUE, FALSE

The directional increase in catchability was modeled by assuming a 1% average annual increase in catchability throughout the history of the fishery, and adjusting the CPUE indices accordingly. 

The environmental covariate was included by modeling catchability as a function of the AMO (see [Data](#data)).

The factorial design of the 7 axes of uncertainty, each with 2 or 3 levels, resulted in an uncertainty grid of 288 OMs.

# MSE Framework
The `SWOMSE` R package has been developed to conduct the MSE for the Atlantic swordfish fishery. All code used for the MSE is open-source and reproducible. Group members can install the package and reproduce the analysis on their own machines.

## Installing the package
The `SWOMSE` package can be installed directly from the [GitHub repository](https://github.com/ICCAT/nswo-mse) using the `devtool` package:

```{r, eval=FALSE, echo=TRUE}
# install.packages("devtools")
devtools::install_github("ICCAT/nswo-mse", auth_token='your_personal_access_token')
```

Note that as this repository is private, you will need to provide a personal access token to download and install from GitHub. See [here](https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token) for information on creating a personal access token.

## MSEtool
The `SWOMSE` package used for the swordfish MSE uses the `MSEtool` framework. The `MSEtool` package is automatically installed when `SWOMSE` is installed, and all `MSEtool` functions are available to the user when the `SWOMSE` package is loaded.

`MSEtool` is an R package that has been developed for conducting fast, flexible, and transparent, MSE for a wide range of fisheries. `MSEtool` is part of the [`openMSE`](https://cran.r-project.org/package=openMSE) collection of packages. A non-technical description of `MSEtool` and its key features is available on the [`openMSE` website](https://openmse.com/).

The operating model in `MSEtool`, including assumptions and equations, is described in detail in @carruthersDataLimitedMethodsToolkit2018a.

## Key Model Assumptions
The MSE operating model differs in several ways from the SS3 model. 

### Single Stock
The MSE OM assumes a single stock (i.e, female and male combined) rather than the female and male populations modeled in SS3. The MSE model was constructed so that the total numbers-at-age and the depletion in the terminal year match the SS3 model. 

The combined weight-at-age in the MSE OMs was calculated as a weighted average of the female and male weight-at-age in the SS3 model. As the weight-at-age is used to scale the numbers-at-age to biomass, this has the effect of slightly different absolute catch and biomass levels between the two modeling frameworks. However, the relative trend in both catch and biomass is closely matched between the MSE OM and the SS3 models. Provided that the candidate management procedures use information on the relative trends in fishery data (e.g., indices of abundance and historical landings) rather than the absolute level, the disparity in absolute magnitude between the two OM frameworks is unlikely to impact the relative performance of the CMPs.

See [Importing OMs into MSE Framework](#importing-oms-into-mse-framework) for more details on the comparision between the population dynamics predicted by the SS3 model and those generated in the MSE OMs.

### Aggregated Fleet
The MSE OM combines the exploitation pattern (selectivity and fishing mortality) of the 8 fishing fleets into 1 aggregated fleet. As management recommendations (i.e., annual TAC advice) are not fleet-specific, it is not necessary to explictily model the individual fleets in the MSE. 

### Spatial Structure
The MSE OM is a spatial model and can include any number of areas and age-based movement. However, following the [Assessment Model](#model-structure), the MSE OMs do not assume any spatial structure.

# Importing OMs into MSE Framework
The 288 OMs in the uncertainty grid, developed using the SS3 software, (see [OM Conditioning](#om-conditioning) were imported into MSE framework using the `SS2OM` function in `MSEtool` (see [here](https://msetool.openmse.com/reference/SS2MOM.html) for details on the function).

As described [above](#single-stock), differences in the structure of the MSE operating model and the SS3 assessment model resulted in differences in the predicted population dynamics in terms of absolute magnitude, but closely matched the dynamics in relative trends in catch and spawning biomass.

The MSE framework generates a report comparing the populating dynamics predicted by SS3 and those generated when the SS3 model is imported into the MSE framework. See [here](../OM_Compare/OM_1.html) for an example report for one OM from the uncertainty grid.

```{r message=FALSE, warning=FALSE, cache=TRUE}
OM.root <- 'G:/My Drive/1_Projects/North_Atlantic_Swordfish/OMs/Grid_2020'
OMgrid.dir <- file.path(OM.root, "grid_2020")
OMgrid.dirs <- list.dirs(OMgrid.dir, recursive = FALSE)

ord <- lapply(strsplit(OMgrid.dirs, 'iter'), '[[', 2) %>% as.numeric() %>% order()
OMgrid.dirs <- OMgrid.dirs[ord]
OM <- SS2OM(OMgrid.dirs[1], nsim=3)

plot_SS2OM(OM, OMgrid.dirs[1], open_file = FALSE, dir="../OM_Compare", filename='OM_1')
```

# OM Validation

> The OMs are currently being (re-)conditioned and this section will be updated when the conditioning is complete.

## OM Summary Report
A report summarizing the parameters, estimated reference points, and predicted stock dynamics for the 288 OMs in the uncertainty grid is available on the North Atlantic Swordfish MSE [homepage](https://iccat.github.io/nswo-mse/). 

## OM Diagnostic Reports
Individual diagnostic reports with objective function values and plots of model fits and patterns in residuals are available for each of the 288 OMs on the North Atlantic Swordfish MSE [homepage](https://iccat.github.io/nswo-mse/).

## Index Fit Report
An Index Fit report, showing the fits and patterns in residuals for the fleet and survey indices is available on the North Atlantic Swordfish MSE [homepage](https://iccat.github.io/nswo-mse/).


# Simulation Specifications
```{r}
OM <- SWOMSE::OM_1
```

The current simulation specifications for the MSE are:

> Note: these are default settings and need to be confirmed by the Group

1. Management interval: `r OM@interval` (i.e., TAC updated every year)
2. Number of projection years: `r OM@proyears`
3. Number of simulations per OM: `r OM@nsim`

# Historical Spool-Up Period
The historical spool-up period was generated by importing the output from the SS3 assessment models and running the MSE simulation framework to recreate the historical fishery dynamics. No additional uncertainty was added to the historical simulations; that is, all `r OM@nsim` simulations were identical (e.g., same recruitment deviations) for the historical spool-up period.

## Historical Data
Fishery data was generated by the MSE framework at the end of the spool-up period. There were three main sources of data available to the CMPs: 1) an index of abundance, 2) catch data, 3) length composition data.

### Index of Abundance
At the 2020 Swordfish MSE technical meeting (4 – 5 June 2020), the Group discussed the use of the combined index [@ortizUpdatedCombinedBiomass2017] that was used in 2017 in the development of CMPs. Although the combined index was not used in the OM conditioning, it closely tracks the predicted abundance in the OMs and could be used as a single index for use in the CMPs.

The MSE framework can include any number of indices of abundance. Currently, one index of abundance is included in the MSE framework and made available to the CMPs.

The Group decided to use the combined index in the initial development and testing of CMPs, and to conduct further investigations in the future on the effect of conditioning the OMs using the combined index. 

The combined index was imported into the `SWOMSE` framework and made available to the CMPs (Figure \@ref(fig:index-plot)). 

```{r index-plot, fig.cap='The combined index for the North Atlantic swordfish fishery. See text for details.'}
Index <- OM@cpars$Data@Ind[1,]
Index <- Index/mean(Index, na.rm=TRUE)

plot(OM@cpars$Data@Year, Index, type="l", lwd=2, xlab="Year", ylab="Scaled CPUE",
     ylim=c(0, max(Index, na.rm=TRUE)))

```

### Catch Data
The catch data used in the OM conditioning were made available in the simulated data that was provided to the CMPs (Figure \@ref(fig:catch-plot)). 

```{r catch-plot, fig.cap='The historical total catch data used in the MSE for the North Atlantic swordfish.'}
Catch <- OM@cpars$Data@Cat[1,]

plot(OM@cpars$Data@Year, Catch, type="l", lwd=2, xlab="Year", ylab="Catch", ylim=c(0, max(Catch)))

```

### Length Composition Data
The length composition data used in the OM conditioning were made available in the simulated data that was provided to the CMPs (Figure \@ref(fig:length-plot)).

```{r length-plot, fig.cap='The length composition data used in the MSE for the North Atlantic swordfish.', cache=TRUE}
Data <- OM@cpars$Data
CALmids <- Data@CAL_mids
CAL <- Data@CAL[1,,]

DF <- data.frame(Year=Data@Year, Bin=rep(CALmids, each=length(Data@Year)),
                 Length=as.vector(CAL)
) 
DF <- DF %>% filter(is.na(Length)==FALSE)

library(ggplot2)
ggplot(DF, aes(x=Bin, y=Length)) +
  facet_wrap(~Year) +
  geom_bar(stat='identity') +
  theme_classic() +
  labs(x="Length Class (cm)", y="Count")

```

### Life-History Parameters
At this point, no CMPs requiring estimates of life-history values have been proposed to be included in the analysis. 

# Projection Period

## Assumptions
### Recruitment
The stock-recruitment relationship in the projection years was modeled using the Beverton-Holt function, with steepness fixed at the value assumed in the OM conditioning.

Recruitment deviations for the projection period were generated assuming a log-normal distribution with mean $\mu_R$ and variance $\sigma_R^2$, calculated as:

$$\mu_R = -0.5\sigma_R^2\left(1-\frac{\text{AC}}{\sqrt{(1-\text{AC}^2)}}\right)$$

where AC is the lag-1 autocorrelation factor calculated from the historical recruitment deviations and $\sigma_R^2$ is the variance of the recruitment deviations specified in the OM (i.e., sigmaR^2 defined [above](#om-uncertainty-grid)).

The recruitment deviations for the projection period were generated independently for each simulation. 

### Life-History
Biological parameters such as mean weight-at-age and maturity-at-age were constant for all years (historical and projection).

### Selectivity
Selectivity-at-length for the projection years was fixed to the estimated selectivity pattern from the last historical year for each OM.

### Catchability
No time-varying catchability was assumed for the projection years. 

## Future Catches
The total allowable catch (TAC) recommended by the CMPs was assumed to be implemented without error. That is, annual catches were equal to the TAC recommendations (provided sufficient vulnerable biomass was available).

## Generation of Future Data

### Indices
The index of abundance in the projection years was generated by adding observation error to the projected total biomass, and standardizing to be on the same scale as the historical index.

The observation error was generated by calculating the statistical properties of the residuals from the fit of the combined index to the simulated total abundance during the historical period. The procedure for calculating the residuals for the projection years is described in detail in the [openMSE documentation](https://openmse.com/features-conditioning-oms/indices/).

### Catches 
The observed catches in the projection years was generated by maintaining the catch observation error from the historical period.

Note that as the SS3 model used to condition the operating models assumed no catch observation error and fitted the catches perfectly, the MSE assumes no catch observation error in the projection years.

### Length Composition
Length composition data for the projection years was generated using the aggregated selectivity pattern and assuming the effective sample size specified in the OM.


# Candidate Management Procedures
At this point, the candidate management procedures have not yet been developed.

The Group decided that CMP development work should involve the national scientists. A small group was formed at the November 2020 MSE technical meeting, lead by Dr K. Gillespie, with the aim of continuing the CMP development work in 2021.

A [CMP Development Guide](https://iccat.github.io/nswo-mse/CMP-Development-Guide.html) is available on the swordfish [MSE homepage](https://iccat.github.io/).

# Performance Metrics
Performance metrics have not yet been finalized. A small group was established at the November 2020 MSE technical meeting with the task of finalizing the set of performance metrics that will be used to evaluate the MSE results. 

A Google sheet has been created for Members to add [Proposed Performance Metrics](https://docs.google.com/spreadsheets/d/1NytREnFCZ6OPrhXT5E5Wi8Y22w-ZmENY8kEZqDH_FQE/edit?usp=sharing).

The proposed Performance Metrics will be added here as they are developed.

# References


